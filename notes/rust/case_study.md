# Rust采坑记(案例分析)

记录我工作中遇过的坑以及生产事故，不仅仅是Rust语言相关的坑和事故(虽然我大部分工作内容都是Rust开发)

## rails - 注释掉了登录验证方法

```
案例发生时间: 2019年12月
严重性和损失预估: 生产事故(持续1周，用的人少1-2周后才发现出问题)
事故原因: 接手同事A写的Rails项目，开发环境登录跳转SSO/CAS单点登录总失败，于是注释掉登录验证改为固定账号登入去测试Rails网页修改效果，不小心把不该提交的模块代码也提交了
教训: git add .时一定要很清楚自己改了哪些代码，可以git diff确认下改动内容
```

## android - BottomNavigationView切Fragment时丢掉了WebSocketListener

```
案例发生时间: 2020年4月
严重性和损失预估: 生产事故(持续3-4小时，用户某些功能无法使用，没给公司造成像偷币那样的直接经济损失)，安卓端币币交易页面WebSocket出问题无法使用
事故原因:
    换了底部导航栏和WebSocket库之后
    BottomNavigationView切换Fragment时流程有点「特殊」，例如页面1->页面2时流程如下:
    1. 页面2.onCreateView
    2. 页面2.onResume
    3. 页面1.onPause
    所以不能在页面1的onPause中清空回调监听，不然会把页面2辛辛苦苦设好的listener清掉
    首页三个Tab页都是共用market_list频道，不需要在Fragment切换时取消订阅
    只需在离开MainActivity时取消订阅所有频道即可
解决过程: 先推送上个版本的apk的强制更新(回滚)，不断地打log直到发现底部导航栏切换Fragment的生命周期中会丢掉WebSocket的onMessage回调
教训: 出生产事务时应立即停止吃饭去回滚代码，leader没吃午饭在Debug的时候，我居然有时间去吃饭，自己写错代码害得leader背锅没吃午饭
```

## async - 异步runtime内要用异步的Mutex

```
案例发生时间: 2020年4月
严重性和损失预估: Rust撮合系统开发阶段困难，如果无法解决会让leader砍掉写了1-2个月的Rust项目
解决过程: 打log发现异步函数运行有点无序，Task1调用A函数成功获取Mutex锁
教训: 出生产事务时应立即停止吃饭去回滚代码，leader没吃午饭在Debug的时候，我居然有时间去吃饭，自己写错代码害得leader背锅没吃午饭
```

## 时区和夏令时(daynight saving time)问题 - 夏令时问题导致数据库写入数据的时间不对

TODO

## 集成测试不发短信和邮件 - 乱发邮件容易提高Amazon SES拒信率

```
案例发生时间: 2020年11月
严重性和损失预估: 可能会增加Amazon SES的因拒信率提升而停掉公司的服务
事故原因:
    集成测试中随机生成新用户的邮箱在对方域名下可能不存在这个用户，
    于是对方域名的风控系统就会告诉SES你们的某某乱发邮件，都是发给不存在的用户，可能是广告或滥用
    于是SES得到返回后就会怀疑我们在用SES乱发广告，拒信率有点高，最终停掉我们的SES服务
    集成测试里乱发邮件，不仅可能导致对方域名将我们拉黑或spam掉，还可能导致SES停掉我们服务
解决方案:
    1. 测试账号应用"test+${随机字母数字}@${公司域名}"格式的邮箱，不要用别人的域名
    2. 测试环境应该不需要发任何邮件和短信，email_sender应添加过滤器email.starts_with(TEST_EMAIL_PREFIX) && email.ends_with(TEST_EMAIL_SUFFIX)
    3. 对于重置密码邮件发送接口的测试，应当独立开发一套仅限127.0.0.1访问的私有API，这些私有API仅仅能查询满足测试账号邮箱格式的邮件激活码
    4. 生产环境部署后，需要一些普罗米修斯之类的第三方运维监控平台，它们要求我们的服务器提供相应的API，可以在warp框架设置request防火墙
教训: 前几天才看到一个v2ex的帖子说测试环境不能发真实短信和邮件，怎么就不长记性？
```
